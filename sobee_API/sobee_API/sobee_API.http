@baseUrl = https://localhost:7058

### ============================================================
### GUEST END-TO-END FLOW (Cart -> Promo -> Totals -> Checkout)
### - IMPORTANT: Step 2 issues guest headers (X-Session-Id / X-Session-Secret)
### - Copy them into @sessionId / @sessionSecret before running the rest
### ============================================================


### ------------------------------------------------------------
### 0) Get products (pick a productId with known stock/price)
### ------------------------------------------------------------
GET {{baseUrl}}/api/products
Accept: application/json


### ------------------------------------------------------------
### 1) (Optional) Clear any existing guest cart (requires session vars)
### - Skip this if you don't have session vars yet
### ------------------------------------------------------------
# DELETE {{baseUrl}}/api/cart
# Accept: application/json
# X-Session-Id: {{sessionId}}
# X-Session-Secret: {{sessionSecret}}


### ------------------------------------------------------------
### 2) Add item to cart as GUEST (ISSUES guest session headers)
### - Copy response headers into @sessionId / @sessionSecret below
### ------------------------------------------------------------
POST {{baseUrl}}/api/cart/items
Content-Type: application/json
Accept: application/json

{
  "productId": 1004,
  "quantity": 1
}


### ------------------------------------------------------------
### 3) Set guest session vars (PASTE from response headers of step 2)
### ------------------------------------------------------------
@sessionId = 0845441a-6f8d-43b1-8d3f-7cb9f24a0631
@sessionSecret = z8gNN48G83nhthtd2gETRPfM0Eu44aE5H2ZvZO05lbA=


### ------------------------------------------------------------
### 4) Get cart as GUEST (should persist + show totals)
### ------------------------------------------------------------
GET {{baseUrl}}/api/cart
Accept: application/json
X-Session-Id: {{sessionId}}
X-Session-Secret: {{sessionSecret}}


### ------------------------------------------------------------
### 5) Add same item again (tests "increment existing item" stock logic)
### ------------------------------------------------------------
POST {{baseUrl}}/api/cart/items
Content-Type: application/json
Accept: application/json
X-Session-Id: {{sessionId}}
X-Session-Secret: {{sessionSecret}}

{
  "productId": 1004,
  "quantity": 1
}


### ------------------------------------------------------------
### 6) Get cart (grab cartItemId for product 1003)
### ------------------------------------------------------------
GET {{baseUrl}}/api/cart
Accept: application/json
X-Session-Id: {{sessionId}}
X-Session-Secret: {{sessionSecret}}


### ------------------------------------------------------------
### 7) Update quantity (set cartItemId from step 6 response)
### - Replace 4 with your actual cartItemId
### ------------------------------------------------------------
PUT {{baseUrl}}/api/cart/items/1005
Content-Type: application/json
Accept: application/json
X-Session-Id: {{sessionId}}
X-Session-Secret: {{sessionSecret}}

{
  "quantity": 2
}


### ------------------------------------------------------------
### 8) Stock enforcement (expect 409 Conflict)
### - Set an intentionally huge quantity
### - Replace 4 with your cartItemId again
### ------------------------------------------------------------
PUT {{baseUrl}}/api/cart/items/1006
Content-Type: application/json
Accept: application/json
X-Session-Id: {{sessionId}}
X-Session-Secret: {{sessionSecret}}

{
  "quantity": 999999
}


### ------------------------------------------------------------
### 9) Apply promo (promo must exist + not expired)
### ------------------------------------------------------------
POST {{baseUrl}}/api/cart/promo/apply
Content-Type: application/json
Accept: application/json
X-Session-Id: {{sessionId}}
X-Session-Secret: {{sessionSecret}}

{
  "promoCode": "SUMMER10"
}


### ------------------------------------------------------------
### 10) Get cart (should show promo + subtotal/discount/total)
### ------------------------------------------------------------
GET {{baseUrl}}/api/cart
Accept: application/json
X-Session-Id: {{sessionId}}
X-Session-Secret: {{sessionSecret}}


### ------------------------------------------------------------
### 11) Checkout as GUEST (now requires VALID session id + secret)
### - Should create order, decrement stock, clear cart
### - Adjust request body fields if your CheckoutRequest differs
### ------------------------------------------------------------
POST {{baseUrl}}/api/orders/checkout
Content-Type: application/json
Accept: application/json
X-Session-Id: {{sessionId}}
X-Session-Secret: {{sessionSecret}}

{
  "shippingAddress": "123 Test St, Test City, OH",
  "paymentMethodId": 1
}


### ------------------------------------------------------------
### 12) Get cart after checkout (should be empty + totals 0)
### ------------------------------------------------------------
GET {{baseUrl}}/api/cart
Accept: application/json
X-Session-Id: {{sessionId}}
X-Session-Secret: {{sessionSecret}}


### ------------------------------------------------------------
### 13) Guest orders list (should show the created order)
### - If your route differs, update it accordingly
### ------------------------------------------------------------
GET {{baseUrl}}/api/orders/my
Accept: application/json
X-Session-Id: {{sessionId}}
X-Session-Secret: {{sessionSecret}}


### ------------------------------------------------------------
### 14) Guest order detail (set orderId from step 11 or step 13)
### ------------------------------------------------------------
GET {{baseUrl}}/api/orders/1007
Accept: application/json
X-Session-Id: {{sessionId}}
X-Session-Secret: {{sessionSecret}}


### ------------------------------------------------------------
### 15) Guest security tests (new hardened behavior)
### ------------------------------------------------------------

### 15.1 Missing secret should FAIL (expect 400 BadRequest)
GET {{baseUrl}}/api/orders/1004
Accept: application/json
X-Session-Id: {{sessionId}}

### 15.2 Invalid secret should FAIL (expect 400 BadRequest)
GET {{baseUrl}}/api/orders/1004
Accept: application/json
X-Session-Id: {{sessionId}}
X-Session-Secret: INVALID_SECRET


### ------------------------------------------------------------
### 16) (Optional) Remove promo (should be 400 after checkout if no promo exists)
### ------------------------------------------------------------
DELETE {{baseUrl}}/api/cart/promo
Accept: application/json
X-Session-Id: {{sessionId}}
X-Session-Secret: {{sessionSecret}}
