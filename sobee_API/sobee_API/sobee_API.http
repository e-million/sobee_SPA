@baseUrl = https://localhost:7058

### =========================================================
### 0) SET THESE AFTER STEP 1 RESPONSE HEADERS
### =========================================================
@sessionId = de4b9019-ab6e-4942-8c04-8ead1fdd3a96
@sessionSecret = qxP/nEOxzKruy6Ry6kIECSHecsAtFD+Tew2Ogb8LPG4=
@token = CfDJ8FE_QEmxr_5Gl8E9uQQwwd0zqRKrNsdBvGbSSlesJOFhiv9zLx1rsuAF9MfMZCfA0MMBSl2xJlgkXwC8a4P3VZTOdREYmILR_TUsoMj0TKnij0FsoiNZo9n8OR0VtIlPbe2iMwoixcHbE6jyb-ZkxH7vXukaO9_6OjN1TuQhoPy-b8vv3u_VsmvwdCSt19_HVoWPQDlkOEcRq2uGKDpe_Lo6wu7uuo6nkwF4u_1NuMYtBGSD269C5QQnrHzvhokNX7cqSH56liDUdLtaIRKLoqplYcxUd1nqJOsrudXVYtXAhAjPs5wrOUkrcUeZkYQkqrK0l5Nbf1rrIy_ocz5CDYDYkLwKbL6p2_QeKU5PNwH8jB6TMU_t2_Z_WGVc5x28n3jngm6X949cq1-DgHoqvDpwEHr3ZFivzcH_ueeNCuL-sdpjsmv9ljAepgpWCsHN-ndW3VePR_e5D4nTpBbN4825_N8q-_zfFxydKx6vmVqVxdjpZfnRQAJVzq8h-uVuODEBG1l42ojF8wgJEBwboybkZKPWxufalJLc_csMpONkYtAGcZOcytujridWlBsYIfbVx_Q3SF9S7St1EZM70dEfW_5k7zC_SZPk9oao5STBTNNfwlc3wwDGfkBcaf2GtWyxeApS8JSkZQvtgsZfGgMRjO0gq5aFSsBK7hCP4dmLIhBtCm904xaqj0snp2MLDFkTYGvZ2--Lg59M0rdKjEY

### =========================================================
### 1) GET CART AS GUEST (creates guest session + cart)
### =========================================================
GET {{baseUrl}}/api/cart

### EXPECTED:
### - 200 OK
### - Response headers include:
###   - X-Session-Id: <guid>
###   - X-Session-Secret: <secret>
### - Response body owner="guest"
### ACTION:
### - Copy X-Session-Id into @sessionId
### - Copy X-Session-Secret into @sessionSecret

### =========================================================
### 2) ADD ITEM AS GUEST (uses session headers)
### =========================================================
POST {{baseUrl}}/api/cart/items
Content-Type: application/json
X-Session-Id: {{sessionId}}
X-Session-Secret: {{sessionSecret}}

{
  "productId": 1,
  "quantity": 2
}

### EXPECTED:
### - 200 OK
### - owner="guest"
### - items contains productId=1 quantity=2

### =========================================================
### 3) CONFIRM GUEST CART HAS ITEMS
### =========================================================
GET {{baseUrl}}/api/cart
X-Session-Id: {{sessionId}}
X-Session-Secret: {{sessionSecret}}

### EXPECTED:
### - 200 OK
### - owner="guest"
### - items still present

### =========================================================
### 4) REGISTER (if needed)
### =========================================================
POST {{baseUrl}}/register
Content-Type: application/json

{
  "email": "testuser1@local.com",
  "password": "Test123!",
  "firstName": "Test",
  "lastName": "User"
}

### EXPECTED:
### - 200 or 201 (depends on your controller)
### - If already exists, you may get 400/409; proceed to login.

### =========================================================
### 5) LOGIN (Get JWT)
### =========================================================
POST {{baseUrl}}/login
Content-Type: application/json

{
  "email": "testuser1@local.com",
  "password": "Test123!"
}

### EXPECTED:
### - 200 OK
### - Response contains accessToken (or token)
### ACTION:
### - Copy token into @token

### =========================================================
### 6) GET CART AS AUTHENTICATED + INCLUDE GUEST SESSION HEADERS
###    (THIS IS THE MERGE TEST)
### =========================================================
GET {{baseUrl}}/api/cart
Authorization: Bearer {{token}}
X-Session-Id: {{sessionId}}
X-Session-Secret: {{sessionSecret}}

### EXPECTED (after the CartController fix):
### - 200 OK
### - owner="user"
### - userId is NOT null
### - items includes the guest items (productId=1 quantity=2)
### - guest session should be invalidated server-side (RotateGuestSessionAsync)

### =========================================================
### 7) GET CART AS AUTHENTICATED (NO SESSION HEADERS)
### =========================================================
GET {{baseUrl}}/api/cart
Authorization: Bearer {{token}}

### EXPECTED:
### - 200 OK
### - owner="user"
### - cart still has the merged items

### =========================================================
### 8) CHECKOUT AS AUTHENTICATED
### =========================================================
POST {{baseUrl}}/api/orders/checkout
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "shippingAddress": "123 Test St, Cincinnati, OH 45202",
  "shippingMethodId": null,
  "paymentMethodId": null
}

### EXPECTED:
### - 200 OK
### - returns created order with items
### - cart items cleared (cart row remains)

### =========================================================
### 9) GET MY ORDERS (AUTHENTICATED)
### =========================================================
GET {{baseUrl}}/api/orders/my
Authorization: Bearer {{token}}

### EXPECTED:
### - 200 OK
### - array of orders including the one from checkout

### =========================================================
### 10) OPTIONAL: TRY USING OLD GUEST SESSION AFTER MERGE
###     (should NOT give access to old guest cart; will create a NEW guest session)
### =========================================================
GET {{baseUrl}}/api/cart
X-Session-Id: {{sessionId}}
X-Session-Secret: {{sessionSecret}}

### EXPECTED:
### - 200 OK (because allowCreateGuestSession=true for cart endpoints)
### - BUT: should issue NEW X-Session-Id / X-Session-Secret headers
### - and return a NEW empty guest cart
### (This confirms rotation/invalidation is working)
