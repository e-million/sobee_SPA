<app-main-layout>
  <section class="section bg-slate-50 min-h-[calc(100vh-4rem)]">
    <div class="container-wide">
      <!-- Header -->
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-8">
        <div>
          <h1 class="text-3xl md:text-4xl font-display font-bold text-slate-800">Checkout</h1>
          <p class="text-slate-600 mt-2">Complete your order by providing shipping and payment details.</p>
        </div>
        <button
          type="button"
          (click)="goBack()"
          class="text-sm text-slate-500 hover:text-primary-600 transition-colors flex items-center gap-1"
        >
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
          </svg>
          Back to cart
        </button>
      </div>

      <!-- Error Alert -->
      @if (error()) {
        <div class="mb-6 p-4 rounded-lg border border-red-200 bg-red-50 text-red-700 flex items-start gap-3">
          <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span>{{ error() }}</span>
        </div>
      }

      @if (cartService.cart(); as cart) {
        @if (cart.items.length > 0) {
          <div class="grid lg:grid-cols-[minmax(0,1fr)_minmax(300px,400px)] gap-8">
            <!-- Checkout Form -->
            <div class="space-y-6">
              <form (ngSubmit)="placeOrder()" #checkoutFormRef="ngForm">
                <!-- Shipping Address Card -->
                <div class="card p-6 mb-6">
                  <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 rounded-full bg-primary-100 flex items-center justify-center">
                      <svg class="w-5 h-5 text-primary-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                      </svg>
                    </div>
                    <div>
                      <h2 class="text-lg font-semibold text-slate-800">Shipping Address</h2>
                      <p class="text-sm text-slate-500">Where should we deliver your order?</p>
                    </div>
                  </div>

                  <div>
                    <label for="shippingAddress" class="block text-sm font-medium text-slate-700 mb-2">
                      Full Address <span class="text-red-500">*</span>
                    </label>
                    <textarea
                      id="shippingAddress"
                      [(ngModel)]="checkoutForm.shippingAddress"
                      name="shippingAddress"
                      required
                      rows="3"
                      placeholder="123 Main Street, Apt 4B&#10;New York, NY 10001"
                      class="input w-full resize-none"
                      [class.input-error]="checkoutFormRef.submitted && !checkoutForm.shippingAddress"
                    ></textarea>
                    @if (checkoutFormRef.submitted && !checkoutForm.shippingAddress) {
                      <p class="mt-1 text-sm text-red-500">Shipping address is required</p>
                    }
                  </div>
                </div>

                <!-- Billing Address Card -->
                <div class="card p-6 mb-6">
                  <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 rounded-full bg-primary-100 flex items-center justify-center">
                      <svg class="w-5 h-5 text-primary-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 1.567-3 3.5S10.343 15 12 15s3-1.567 3-3.5S13.657 8 12 8z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M20 12c0 4.418-3.582 8-8 8s-8-3.582-8-8 3.582-8 8-8 8 3.582 8 8z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 16.5c1.333-2 3.333-3 6-3s4.667 1 6 3" />
                      </svg>
                    </div>
                    <div>
                      <h2 class="text-lg font-semibold text-slate-800">Billing Address</h2>
                      <p class="text-sm text-slate-500">Address associated with your payment method.</p>
                    </div>
                  </div>

                  <div>
                    <label for="billingAddress" class="block text-sm font-medium text-slate-700 mb-2">
                      Full Address <span class="text-red-500">*</span>
                    </label>
                    <textarea
                      id="billingAddress"
                      [(ngModel)]="checkoutForm.billingAddress"
                      name="billingAddress"
                      required
                      rows="3"
                      placeholder="123 Main Street, Apt 4B&#10;New York, NY 10001"
                      class="input w-full resize-none"
                      [class.input-error]="checkoutFormRef.submitted && !checkoutForm.billingAddress"
                    ></textarea>
                    @if (checkoutFormRef.submitted && !checkoutForm.billingAddress) {
                      <p class="mt-1 text-sm text-red-500">Billing address is required</p>
                    }
                  </div>
                </div>

                <!-- Payment Method Card -->
                <div class="card p-6 mb-6">
                  <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 rounded-full bg-primary-100 flex items-center justify-center">
                      <svg class="w-5 h-5 text-primary-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                      </svg>
                    </div>
                    <div>
                      <h2 class="text-lg font-semibold text-slate-800">Payment Method</h2>
                      <p class="text-sm text-slate-500">Select how you'd like to pay</p>
                    </div>
                  </div>

                  @if (paymentMethods().length > 0) {
                    <div class="space-y-3">
                      @for (method of paymentMethods(); track method.paymentMethodId) {
                        <label
                          class="flex items-center gap-4 p-4 rounded-lg border-2 cursor-pointer transition-all"
                          [class.border-primary-500]="checkoutForm.paymentMethodId === method.paymentMethodId"
                          [class.bg-primary-50]="checkoutForm.paymentMethodId === method.paymentMethodId"
                          [class.border-slate-200]="checkoutForm.paymentMethodId !== method.paymentMethodId"
                          [class.hover:border-slate-300]="checkoutForm.paymentMethodId !== method.paymentMethodId"
                        >
                          <input
                            type="radio"
                            name="paymentMethodId"
                            [value]="method.paymentMethodId"
                            [(ngModel)]="checkoutForm.paymentMethodId"
                            required
                            class="w-4 h-4 text-primary-600 border-slate-300 focus:ring-primary-500"
                          />
                          <div class="flex-1">
                            <span class="font-medium text-slate-800">{{ method.description }}</span>
                          </div>
                          <svg class="w-5 h-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                          </svg>
                        </label>
                      }
                    </div>
                  } @else {
                    <div class="flex items-center justify-center py-8">
                      <div class="flex items-center gap-2 text-slate-500">
                        <svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
                          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>Loading payment methods...</span>
                      </div>
                    </div>
                  }
                </div>

                <!-- Action Buttons (Mobile) -->
                <div class="lg:hidden">
                  <button
                    type="submit"
                    [disabled]="loading() || !checkoutFormRef.form.valid"
                    class="btn-primary w-full justify-center"
                  >
                    @if (loading()) {
                      <svg class="w-5 h-5 animate-spin mr-2" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                      Processing...
                    } @else {
                      Place Order
                    }
                  </button>
                </div>
              </form>
            </div>

            <!-- Order Summary Sidebar -->
            <div class="card p-6 h-fit lg:sticky lg:top-24">
              <h2 class="text-xl font-semibold text-slate-800 mb-6">Order Summary</h2>

              <!-- Items List -->
              <div class="space-y-4 mb-6">
                @for (item of cart.items; track item.cartItemId) {
                  <div class="flex items-start gap-3">
                    @if (item.product?.primaryImageUrl) {
                      <img
                        [src]="item.product?.primaryImageUrl"
                        [alt]="item.product?.name ?? 'Product'"
                        class="w-14 h-14 rounded-lg object-cover flex-shrink-0"
                      />
                    } @else {
                      <div class="w-14 h-14 bg-slate-100 rounded-lg flex items-center justify-center flex-shrink-0">
                        <svg class="w-6 h-6 text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                      </div>
                    }
                    <div class="flex-1 min-w-0">
                      <p class="text-sm font-medium text-slate-800 truncate">{{ item.product?.name }}</p>
                      <p class="text-xs text-slate-500">Qty: {{ item.quantity }}</p>
                    </div>
                    <p class="text-sm font-medium text-slate-800">{{ item.lineTotal | currency:'USD':'symbol':'1.2-2' }}</p>
                  </div>
                }
              </div>

              <div class="border-t border-slate-200 pt-4 space-y-3">
                <!-- Subtotal -->
                <div class="flex items-center justify-between text-sm">
                  <span class="text-slate-600">Subtotal</span>
                  <span class="font-medium text-slate-800">{{ cart.subtotal | currency:'USD':'symbol':'1.2-2' }}</span>
                </div>

                <!-- Discount -->
                @if (cart.promo) {
                  <div class="flex items-center justify-between text-sm">
                    <span class="text-slate-600">Discount ({{ cart.promo.code }})</span>
                    <span class="font-medium text-emerald-600">-{{ cart.discount | currency:'USD':'symbol':'1.2-2' }}</span>
                  </div>
                }

                <!-- Shipping -->
                <div class="flex items-center justify-between text-sm">
                  <span class="text-slate-600">Shipping</span>
                  <span class="font-medium text-emerald-600">Free</span>
                </div>

                <!-- Total -->
                <div class="flex items-center justify-between pt-3 border-t border-slate-200">
                  <span class="text-base font-semibold text-slate-800">Total</span>
                  <span class="text-xl font-bold text-slate-800">{{ cart.total | currency:'USD':'symbol':'1.2-2' }}</span>
                </div>
              </div>

              <!-- Place Order Button (Desktop) -->
              <div class="hidden lg:block mt-6">
                <button
                  type="button"
                  (click)="placeOrder()"
                  [disabled]="loading() || !checkoutFormRef.form.valid"
                  class="btn-primary w-full justify-center"
                >
                  @if (loading()) {
                    <svg class="w-5 h-5 animate-spin mr-2" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Processing...
                  } @else {
                    Place Order
                  }
                </button>
              </div>

              <!-- Security Note -->
              <div class="mt-4 flex items-center gap-2 text-xs text-slate-500">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
                <span>Secure checkout. Your information is protected.</span>
              </div>
            </div>
          </div>
        } @else {
          <!-- Empty Cart State -->
          <div class="text-center py-16 bg-white rounded-2xl border border-slate-200">
            <div class="w-20 h-20 mx-auto mb-6 bg-slate-100 rounded-full flex items-center justify-center">
              <svg class="w-10 h-10 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
              </svg>
            </div>
            <h3 class="text-xl font-semibold text-slate-800 mb-2">Your cart is empty</h3>
            <p class="text-slate-500 mb-6">Add some items to your cart before checking out.</p>
            <button (click)="goBack()" class="btn-primary">Continue Shopping</button>
          </div>
        }
      } @else {
        <!-- Loading State -->
        <div class="grid lg:grid-cols-[minmax(0,1fr)_minmax(300px,400px)] gap-8">
          <div class="space-y-6">
            <div class="card p-6 animate-pulse">
              <div class="flex items-center gap-3 mb-6">
                <div class="w-10 h-10 rounded-full bg-slate-200"></div>
                <div class="space-y-2">
                  <div class="h-4 bg-slate-200 rounded w-32"></div>
                  <div class="h-3 bg-slate-200 rounded w-48"></div>
                </div>
              </div>
              <div class="h-24 bg-slate-200 rounded"></div>
            </div>
            <div class="card p-6 animate-pulse">
              <div class="flex items-center gap-3 mb-6">
                <div class="w-10 h-10 rounded-full bg-slate-200"></div>
                <div class="space-y-2">
                  <div class="h-4 bg-slate-200 rounded w-32"></div>
                  <div class="h-3 bg-slate-200 rounded w-48"></div>
                </div>
              </div>
              <div class="space-y-3">
                <div class="h-14 bg-slate-200 rounded"></div>
                <div class="h-14 bg-slate-200 rounded"></div>
              </div>
            </div>
          </div>
          <div class="card p-6 h-fit animate-pulse">
            <div class="h-6 bg-slate-200 rounded w-32 mb-6"></div>
            <div class="space-y-4">
              <div class="flex gap-3">
                <div class="w-14 h-14 bg-slate-200 rounded-lg"></div>
                <div class="flex-1 space-y-2">
                  <div class="h-4 bg-slate-200 rounded w-3/4"></div>
                  <div class="h-3 bg-slate-200 rounded w-1/4"></div>
                </div>
              </div>
            </div>
            <div class="border-t border-slate-200 mt-6 pt-4 space-y-3">
              <div class="h-4 bg-slate-200 rounded"></div>
              <div class="h-4 bg-slate-200 rounded w-3/4"></div>
              <div class="h-6 bg-slate-200 rounded w-1/2"></div>
            </div>
            <div class="h-12 bg-slate-200 rounded mt-6"></div>
          </div>
        </div>
      }
    </div>
  </section>
</app-main-layout>
