<app-main-layout>
  <section class="section bg-white">
    <div class="container-wide">
      @if (loading()) {
        <div class="grid lg:grid-cols-2 gap-10 animate-pulse">
          <div class="aspect-square bg-slate-200 rounded-2xl"></div>
          <div class="space-y-4">
            <div class="h-6 bg-slate-200 rounded w-1/2"></div>
            <div class="h-4 bg-slate-200 rounded w-1/3"></div>
            <div class="h-10 bg-slate-200 rounded w-1/4"></div>
            <div class="h-24 bg-slate-200 rounded w-full"></div>
          </div>
        </div>
      } @else if (notFound()) {
        <div class="text-center py-16">
          <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-primary-100 mb-6">
            <span class="text-3xl font-bold text-primary-600">404</span>
          </div>
          <h1 class="text-3xl md:text-4xl font-display font-bold text-slate-800 mb-3">
            Product not found
          </h1>
          <p class="text-slate-600 mb-8">
            The product you are looking for does not exist or has been removed.
          </p>
          <div class="flex flex-col sm:flex-row items-center justify-center gap-3">
            <a routerLink="/shop" class="btn-primary">Back to shop</a>
            <a routerLink="/" class="btn-outline">Go home</a>
          </div>
        </div>
      } @else if (error()) {
        <div class="text-center py-16">
          <h1 class="text-2xl font-semibold text-slate-800 mb-3">Unable to load product</h1>
          <p class="text-slate-500 mb-6">{{ error() }}</p>
          <button class="btn-primary" routerLink="/shop">Browse products</button>
        </div>
      } @else if (product(); as product) {
        <nav class="flex items-center gap-2 text-sm text-slate-500 mb-6">
          <a routerLink="/" class="hover:text-primary-600 transition-colors">Home</a>
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
          <a routerLink="/shop" class="hover:text-primary-600 transition-colors">Shop</a>
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
          <span class="text-slate-800">{{ product.name ?? 'Product' }}</span>
        </nav>

        <div class="grid lg:grid-cols-2 gap-10">
          <div class="relative">
            <div class="aspect-square overflow-hidden rounded-2xl bg-slate-100">
              <img
                [src]="productImage"
                [alt]="product.name ?? 'Sobee product'"
                width="640"
                height="640"
                loading="lazy"
                decoding="async"
                class="w-full h-full object-cover"
              />
            </div>
            @if (isOutOfStock) {
              <span class="absolute top-4 left-4 bg-slate-800 text-white text-xs font-semibold px-3 py-1 rounded-full">
                Out of Stock
              </span>
            } @else if (isLowStock) {
              <span class="absolute top-4 left-4 bg-accent-500 text-white text-xs font-semibold px-3 py-1 rounded-full">
                Only {{ product.stockAmount }} left
              </span>
            }
          </div>

          <div>
            <div class="flex flex-wrap items-center gap-3 mb-3">
              @if (product.category) {
                <span class="text-xs uppercase tracking-wide text-slate-500">{{ product.category }}</span>
              }
              <div class="flex items-center gap-1">
                @for (star of (product.rating | starRating); track $index) {
                  @if (star === 1) {
                    <svg class="w-4 h-4 text-primary-400" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                    </svg>
                  } @else {
                    <svg class="w-4 h-4 text-slate-300" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                    </svg>
                  }
                }
              </div>
            </div>

            <h1 class="text-3xl md:text-4xl font-display font-bold text-slate-800 mb-3">
              {{ product.name ?? 'Sobee Blend' }}
            </h1>

            <p class="text-2xl font-semibold text-slate-800 mb-4">
              {{ product.price | currency:'USD':'symbol':'1.2-2' }}
            </p>

            <p class="text-slate-600 mb-6">
              {{ product.description ?? 'No description available yet.' }}
            </p>

            <div class="flex flex-wrap items-center gap-4 mb-6">
              <div class="flex items-center border border-slate-200 rounded-lg">
                <button
                  type="button"
                  (click)="updateQuantity(quantity() - 1)"
                  [disabled]="quantity() <= 1 || isOutOfStock"
                  class="w-10 h-10 flex items-center justify-center text-slate-600 hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed rounded-l-lg transition-colors focus-visible:ring-2 focus-visible:ring-primary-500 focus-visible:ring-offset-1"
                >
                  <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M20 12H4" />
                  </svg>
                </button>
                <span class="w-12 text-center text-sm font-medium">{{ quantity() }}</span>
                <button
                  type="button"
                  (click)="updateQuantity(quantity() + 1)"
                  [disabled]="quantity() >= maxQuantity || isOutOfStock"
                  class="w-10 h-10 flex items-center justify-center text-slate-600 hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed rounded-r-lg transition-colors focus-visible:ring-2 focus-visible:ring-primary-500 focus-visible:ring-offset-1"
                >
                  <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                  </svg>
                </button>
              </div>

              <button
                type="button"
                (click)="addToCart()"
                [disabled]="isOutOfStock || maxQuantity === 0"
                class="btn-primary px-6"
              >
                @if (isOutOfStock) {
                  Out of Stock
                } @else {
                  Add to Cart
                }
              </button>

              <button
                type="button"
                (click)="toggleFavorite()"
                [disabled]="favoriteLoading()"
                class="btn-outline px-6"
              >
                @if (favoriteLoading()) {
                  Updating...
                } @else if (isFavorite()) {
                  Remove from Wishlist
                } @else {
                  Add to Wishlist
                }
              </button>

              @if (!isOutOfStock) {
                <span class="text-sm text-slate-500">
                  Max {{ maxQuantity }} per order
                </span>
              }
            </div>

            <div class="border-b border-slate-200 mb-4 flex gap-6">
              <button
                type="button"
                (click)="setTab('description')"
                [class]="activeTab() === 'description'
                  ? 'pb-3 text-slate-800 font-semibold border-b-2 border-primary-500'
                  : 'pb-3 text-slate-500 hover:text-slate-800 transition-colors'"
              >
                Description
              </button>
              <button
                type="button"
                (click)="setTab('ingredients')"
                [class]="activeTab() === 'ingredients'
                  ? 'pb-3 text-slate-800 font-semibold border-b-2 border-primary-500'
                  : 'pb-3 text-slate-500 hover:text-slate-800 transition-colors'"
              >
                Ingredients
              </button>
              <button
                type="button"
                (click)="setTab('reviews')"
                [class]="activeTab() === 'reviews'
                  ? 'pb-3 text-slate-800 font-semibold border-b-2 border-primary-500'
                  : 'pb-3 text-slate-500 hover:text-slate-800 transition-colors'"
              >
                Reviews
              </button>
            </div>

            <div class="text-slate-600 leading-relaxed">
              @if (activeTab() === 'description') {
                <p>{{ product.description ?? 'No description available for this product.' }}</p>
              } @else if (activeTab() === 'ingredients') {
                <p>Ingredient details will be available soon. Reach out to support for more info.</p>
              } @else {
                <div class="space-y-6">
                  <div>
                    <h3 class="text-lg font-semibold text-slate-800 mb-2">Customer reviews</h3>
                    @if (!reviewsLoading()) {
                      <div class="grid md:grid-cols-[minmax(0,180px)_minmax(0,1fr)] gap-6 mb-6">
                        <div class="rounded-xl border border-slate-200 p-4 text-center">
                          <p class="text-xs uppercase tracking-wide text-slate-500">Average rating</p>
                          <p class="text-3xl font-semibold text-slate-800 mt-2">
                            {{ reviewSummary().average | number:'1.1-1' }}
                          </p>
                          <div class="flex items-center justify-center gap-1 mt-2">
                            @for (star of (reviewSummary().average | starRating); track $index) {
                              @if (star === 1) {
                                <svg class="w-4 h-4 text-primary-400" fill="currentColor" viewBox="0 0 20 20">
                                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                </svg>
                              } @else {
                                <svg class="w-4 h-4 text-slate-300" fill="currentColor" viewBox="0 0 20 20">
                                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                </svg>
                              }
                            }
                          </div>
                          <p class="text-xs text-slate-500 mt-2">{{ reviewSummary().total }} ratings</p>
                        </div>
                        <div>
                          <div class="space-y-2">
                            @for (row of getReviewRatingRows(); track row.stars) {
                              <div class="flex items-center gap-3">
                                <span class="w-16 text-xs text-slate-500">{{ row.label }}</span>
                                <div class="flex-1 h-2 rounded-full bg-slate-200 overflow-hidden">
                                  <div class="h-full bg-amber-500" [style.width.%]="getReviewRatingWidth(row.count)"></div>
                                </div>
                                <span class="text-xs text-slate-600 w-8 text-right">{{ row.count }}</span>
                              </div>
                            }
                          </div>
                          @if (reviewSummary().total === 0) {
                            <p class="text-xs text-slate-400 mt-2">No ratings yet.</p>
                          }
                        </div>
                      </div>
                    }
                    @if (reviewsLoading()) {
                      <p class="text-sm text-slate-500">Loading reviews...</p>
                    } @else if (reviews().length > 0) {
                      <div class="space-y-4">
                        @for (review of reviews(); track review.reviewId) {
                          <div class="border border-slate-200 rounded-lg p-4">
                            <div class="flex items-center justify-between gap-3">
                              <div class="flex items-center gap-1">
                                @for (star of (review.rating | starRating); track $index) {
                                  @if (star === 1) {
                                    <svg class="w-4 h-4 text-primary-400" fill="currentColor" viewBox="0 0 20 20">
                                      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                    </svg>
                                  } @else {
                                    <svg class="w-4 h-4 text-slate-300" fill="currentColor" viewBox="0 0 20 20">
                                      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                    </svg>
                                  }
                                }
                              </div>
                              <span class="text-xs text-slate-500">{{ review.created | date:'mediumDate' }}</span>
                            </div>
                            <p class="text-sm text-slate-600 mt-3">{{ review.reviewText }}</p>

                            @if (review.replies.length > 0) {
                              <div class="mt-4 space-y-3 border-t border-slate-200 pt-4">
                                @for (reply of review.replies; track reply.replyId) {
                                  <div class="text-sm text-slate-600">
                                    <div class="flex items-center justify-between gap-3">
                                      <span class="text-xs text-slate-500">Reply</span>
                                      <span class="text-xs text-slate-400">{{ reply.created | date:'mediumDate' }}</span>
                                    </div>
                                    <p class="mt-1">{{ reply.content }}</p>
                                  </div>
                                }
                              </div>
                            }

                            @if (canReply(review)) {
                              <div class="mt-4">
                                <button
                                  type="button"
                                  class="text-sm text-primary-600 hover:text-primary-700"
                                  (click)="toggleReply(review.reviewId)"
                                >
                                  @if (replyOpenIds().has(review.reviewId)) {
                                    Cancel reply
                                  } @else {
                                    Reply
                                  }
                                </button>

                                @if (replyOpenIds().has(review.reviewId)) {
                                  <div class="mt-3 space-y-3">
                                    <textarea
                                      rows="3"
                                      [ngModel]="getReplyDraft(review.reviewId)"
                                      (ngModelChange)="setReplyDraft(review.reviewId, $event)"
                                      placeholder="Write your reply."
                                      class="input resize-none"
                                    ></textarea>
                                    <button
                                      type="button"
                                      class="btn-outline text-sm px-4 py-2"
                                      (click)="submitReply(review)"
                                      [disabled]="replySubmitting()"
                                    >
                                      @if (replySubmitting()) {
                                        Posting...
                                      } @else {
                                        Post reply
                                      }
                                    </button>
                                  </div>
                                }
                              </div>
                            }
                          </div>
                        }
                      </div>
                      @if (reviewsTotalPages > 1) {
                        <div class="mt-6 flex flex-wrap items-center justify-between gap-3 border-t border-slate-200 pt-4">
                          <p class="text-xs text-slate-500">
                            Showing {{ reviewsRangeStart }}-{{ reviewsRangeEnd }} of {{ reviewsTotalCount() }}
                          </p>
                          <div class="flex items-center gap-2">
                            <button
                              type="button"
                              class="btn-outline text-xs px-3 py-1.5"
                              (click)="goToReviewPage(reviewsPage() - 1)"
                              [disabled]="reviewsPage() <= 1"
                            >
                              Prev
                            </button>
                            <span class="text-xs text-slate-500">
                              Page {{ reviewsPage() }} of {{ reviewsTotalPages }}
                            </span>
                            <button
                              type="button"
                              class="btn-outline text-xs px-3 py-1.5"
                              (click)="goToReviewPage(reviewsPage() + 1)"
                              [disabled]="reviewsPage() >= reviewsTotalPages"
                            >
                              Next
                            </button>
                          </div>
                        </div>
                      }
                    } @else {
                      <p class="text-sm text-slate-500">No reviews yet. Be the first to share your feedback.</p>
                    }
                  </div>

                  <div class="border-t border-slate-200 pt-6">
                    <h4 class="text-lg font-semibold text-slate-800 mb-2">Write a review</h4>
                    @if (!canSubmitReview()) {
                      <div class="text-sm text-slate-500">
                        <p>Sign in to share your review.</p>
                        <a routerLink="/login" class="text-primary-600 font-medium inline-flex items-center gap-1 mt-2">
                          Go to login
                          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                          </svg>
                        </a>
                      </div>
                    } @else {
                      @if (reviewsError()) {
                        <div class="mb-3 rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700">
                          {{ reviewsError() }}
                        </div>
                      }
                      <div class="flex items-center gap-2 mb-4">
                        @for (star of getStarOptions(); track star) {
                            <button
                              type="button"
                              (click)="reviewRating.set(star)"
                              [attr.aria-label]="'Rate ' + star + ' star' + (star === 1 ? '' : 's')"
                              class="w-9 h-9 rounded-full border border-slate-200 flex items-center justify-center"
                              [class.bg-primary-500]="reviewRating() >= star"
                              [class.text-white]="reviewRating() >= star"
                              [class.text-slate-500]="reviewRating() < star"
                            >
                            {{ star }}
                          </button>
                        }
                      </div>
                      <textarea
                        rows="4"
                        [ngModel]="reviewText()"
                        (ngModelChange)="reviewText.set($event)"
                        placeholder="Share your experience with this product."
                        class="input resize-none"
                      ></textarea>
                      <button
                        type="button"
                        class="btn-primary mt-4"
                        (click)="submitReview()"
                        [disabled]="reviewSubmitting()"
                      >
                        @if (reviewSubmitting()) {
                          Submitting...
                        } @else {
                          Submit review
                        }
                      </button>
                    }
                  </div>
                </div>
              }
            </div>
          </div>
        </div>

        @if (relatedProducts().length > 0) {
          <section class="mt-16">
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-2xl font-semibold text-slate-800">Related products</h2>
              <a routerLink="/shop" class="text-sm text-slate-500 hover:text-primary-600 transition-colors">
                View all
              </a>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
              @for (related of relatedProducts(); track related.id) {
                <app-product-card
                  [product]="related"
                  (addToCart)="addRelatedToCart($event)"
                ></app-product-card>
              }
            </div>
          </section>
        }
      }
    </div>
  </section>
</app-main-layout>
