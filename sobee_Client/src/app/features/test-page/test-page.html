<div class="test-page">
  <h1>Sobee API Test Page</h1>

  <!-- Messages -->
  @if (message()) {
    <div class="alert alert-success">
      {{ message() }}
      <button (click)="clearMessages()">×</button>
    </div>
  }

  @if (error()) {
    <div class="alert alert-error">
      {{ error() }}
      <button (click)="clearMessages()">×</button>
    </div>
  }

  @if (loading()) {
    <div class="loading">Loading...</div>
  }

  <!-- Auth Status -->
  <div class="section">
    <h2>Authentication Status</h2>
    <p>
      Status:
      @if (authService.isAuthenticated()) {
        <strong class="text-success">Logged In</strong>
      } @else {
        <strong class="text-warning">Guest</strong>
      }
    </p>
    @if (authService.isAuthenticated()) {
      <button (click)="goToOrders()" class="btn btn-secondary">View My Orders</button>
    }
  </div>

  <!-- Login Form -->
  @if (!authService.isAuthenticated()) {
    <div class="section">
      <h2>Login</h2>
      <form (ngSubmit)="login()" #loginFormRef="ngForm">
        <div class="form-group">
          <label>Email:</label>
          <input
            type="email"
            [(ngModel)]="loginForm.email"
            name="email"
            required
            placeholder="user@example.com"
          />
        </div>
        <div class="form-group">
          <label>Password:</label>
          <input
            type="password"
            [(ngModel)]="loginForm.password"
            name="password"
            required
            placeholder="password"
          />
        </div>
        <button type="submit" [disabled]="loading()">Login</button>
      </form>
    </div>

    <!-- Register Form -->
    <div class="section">
      <h2>Register</h2>
      <form (ngSubmit)="register()" #registerFormRef="ngForm">
        <div class="form-group">
          <label>Email:</label>
          <input
            type="email"
            [(ngModel)]="registerForm.email"
            name="regEmail"
            required
            placeholder="user@example.com"
          />
        </div>
        <div class="form-group">
          <label>Password:</label>
          <input
            type="password"
            [(ngModel)]="registerForm.password"
            name="regPassword"
            required
            placeholder="password"
          />
        </div>
        <div class="form-group">
          <label>First Name:</label>
          <input
            type="text"
            [(ngModel)]="registerForm.firstName"
            name="firstName"
            required
            placeholder="John"
          />
        </div>
        <div class="form-group">
          <label>Last Name:</label>
          <input
            type="text"
            [(ngModel)]="registerForm.lastName"
            name="lastName"
            required
            placeholder="Doe"
          />
        </div>
        <div class="form-group">
          <label>Billing Address:</label>
          <input
            type="text"
            [(ngModel)]="registerForm.billingAddress"
            name="billingAddress"
            placeholder="123 Main St"
          />
        </div>
        <div class="form-group">
          <label>Shipping Address:</label>
          <input
            type="text"
            [(ngModel)]="registerForm.shippingAddress"
            name="shippingAddress"
            placeholder="123 Main St"
          />
        </div>
        <button type="submit" [disabled]="loading()">Register</button>
      </form>
    </div>
  } @else {
    <div class="section">
      <button (click)="logout()">Logout</button>
    </div>
  }

  <!-- Cart Section -->
  <div class="section">
    <h2>Shopping Cart</h2>
    <div class="cart-actions">
      <button (click)="loadCart()">Refresh Cart</button>
      @if (cartService.cart() && cartService.cart()!.items.length > 0) {
        <button (click)="goToCheckout()" class="btn-checkout">Proceed to Checkout</button>
      }
    </div>

    @if (cartService.cart(); as cart) {
      <div class="cart-summary">
        <p><strong>Cart ID:</strong> {{ cart.cartId }}</p>
        <p><strong>Owner:</strong> {{ cart.owner }}</p>
        <p><strong>Items:</strong> {{ cart.items.length }}</p>
        <p><strong>Subtotal:</strong> ${{ cart.subtotal.toFixed(2) }}</p>
        @if (cart.promo) {
          <p><strong>Promo:</strong> {{ cart.promo.code }} (-{{ cart.promo.discountPercentage }}%)</p>
          <p><strong>Discount:</strong> -${{ cart.discount.toFixed(2) }}</p>
        }
        <p class="total"><strong>Total:</strong> ${{ cart.total.toFixed(2) }}</p>
      </div>

      @if (cart.items.length > 0) {
        <h3>Cart Items</h3>
        <table class="cart-items">
          <thead>
            <tr>
              <th>Product</th>
              <th>Price</th>
              <th>Qty</th>
              <th>Line Total</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (item of cart.items; track item.cartItemId) {
              <tr>
                <td>{{ item.product?.name }}</td>
                <td>${{ (item.product?.price ?? 0).toFixed(2) }}</td>
                <td>{{ item.quantity }}</td>
                <td>${{ item.lineTotal.toFixed(2) }}</td>
                <td>
                  <button (click)="removeFromCart(item.cartItemId)" class="btn-danger">Remove</button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      } @else {
        <p class="empty-cart">Your cart is empty</p>
      }
    } @else {
      <p>Loading cart...</p>
    }
  </div>

  <!-- Products Section -->
  <div class="section">
    <h2>Products</h2>
    <button (click)="loadProducts()">Refresh Products</button>

    @if (products().length > 0) {
      <div class="products-grid">
        @for (product of products(); track product.id) {
          <div class="product-card">
            @if (product.primaryImageUrl) {
              <img [src]="product.primaryImageUrl" [alt]="product.name || 'Product'" />
            } @else {
              <div class="no-image">No Image</div>
            }
            <h3>{{ product.name }}</h3>
            <p class="price">${{ product.price.toFixed(2) }}</p>
            <p class="description">{{ product.description }}</p>
            <p class="stock">
              @if (product.inStock) {
                <span class="in-stock">In Stock</span>
              } @else {
                <span class="out-of-stock">Out of Stock</span>
              }
            </p>
            <button
              (click)="addToCart(product.id)"
              [disabled]="!product.inStock || loading()"
              class="btn-primary"
            >
              Add to Cart
            </button>
          </div>
        }
      </div>
    } @else {
      <p>No products available</p>
    }
  </div>
</div>
